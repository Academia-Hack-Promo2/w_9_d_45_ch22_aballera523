/*!CK:2869889720!*//*1429199057,*/

if (self.CavalryLogger) { CavalryLogger.start_js(["qO4wJ"]); }

__d("LiveFeedBar",["Arbiter","BanzaiScuba","Event","Run","throttle","SubscriptionsHandler","LitestandMessages","ViewportBounds","CurrentUser","getElementPosition","NavigationMessage","Vector","NewStoriesPillConfig","UserActivity","FbFeedViewportTracking","WaitBeforeNewStoryQE","ViewportAtFeedTop"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w){b.__markCompiled&&b.__markCompiled();var x=null,y=false,z=0,aa=0,ba,ca,da=0,ea=1,fa=2,ga=da,ha,ia=200,ja=function(qa,ra){ra=ra!==(void 0)?ra:-1;new h('feed_newstoriescard').addNormal('user_id',o.getID()).addNormal('event',qa).addInteger('time',Math.round(Date.now()/1000)).addInteger('bar_is_visible',y?1:0).addInteger('story_count',aa).addInteger('stories_fetched',ra).addInteger('load_requests_before_click',z).post();},ka=function(){var qa=s.pill_story_cnt;if(!qa)qa=2;if(aa>=qa&&!y){x.show();ja('render');y=true;}},la=function(){if(y){x.hide();y=false;}},ma={},na=function(){var qa=false,ra=u.getInstance(),sa=n.getTop();for(var ta in ma){if(ra.hasBeenVisible(ta)){delete ma[ta];continue;}var ua=ma[ta];if(sa<=p(ua).y){qa=true;break;}}return qa;},oa=false,pa={init:function(qa){if(oa)return;oa=true;x=qa;ga=da;this._scrollDownWaitTimeMs=s.scroll_down_wait_time_ms;this._scrollThrottleTimeMs=s.scroll_throttle_time_ms;ia=s.pill_scroll_threshold;this._subscriptions=new l();pa._scrollDownWaitTimeout();this._subscriptions.addSubscriptions(qa.subscribe('click',this._barClickHandler),g.subscribe(m.NEW_STORIES_DISPLAYED,function(){aa=0;}),g.subscribe('Stream/totalHeadLoadedStories',function(ra,sa){this._liveUpdatesAvailable(sa.hiddenCount,sa.fblogo);}.bind(this)),i.listen(window,'scroll',k(this._handleScroll.bind(this),this._scrollThrottleTimeMs,this)),g.subscribe(m.PILL_PAGELET_REQUEST_SENT,function(){z+=1;ja('load_request');}),g.subscribe(q.NAVIGATION_BEGIN,this._cleanup.bind(this)));if(v.showPillAfterMove)this._subscriptions.addSubscriptions(i.listen(window,'focus',function(){pa._processStories(true);}));j.onLeave(this._cleanup.bind(this));},_handleScrollUp:function(){if(ga!==ea){ga=ea;ha=ba;}else if(ha-ba>ia)pa._processStories(true);},_handleScrollDown:function(){if(ga!==fa){ga=fa;ha=ba;}else if(ba-ha>ia)la();},_handleScroll:function(){ca=ba;ba=r.getScrollPosition().y;if(ca!==(void 0)&&ba!==(void 0))if(ba<ca){this._handleScrollUp();}else this._handleScrollDown();},_barClickHandler:function(){ja('click');z=0;aa=0;la();g.inform(m.NEW_STORIES_DISPLAY_NOW);},_scrollDownWaitTimeout:function(){var qa=pa._scrollDownWaitTimeMs;if(!t.isActive(pa._scrollDownWaitTimeMs)){pa._processStories(false);}else{var ra=Date.now()-t.getLastActive();qa=pa._scrollDownWaitTimeMs-ra;}this._scrollDownTimeoutListener=setTimeout(pa._scrollDownWaitTimeout,qa);},_processStories:function(qa){if(aa>0)if(w.isTrue()){la();var ra=m.NEW_STORIES_WAIT_DISPLAY;if(qa)ra=m.NEW_STORIES_DISPLAY_NOW;g.inform(ra);}else if(qa||!na())ka();},_liveUpdatesAvailable:function(qa,ra){ja('load_response',qa-aa);aa=qa;if(aa>0)if(w.isTrue()){la();if(ra){g.inform(m.NEW_STORIES_DISPLAY_NOW);}else g.inform(m.NEW_STORIES_WAIT_DISPLAY);}else if(!t.isActive(pa._scrollDownWaitTimeMs)&&!na())ka();},_cleanup:function(){this._subscriptions&&this._subscriptions.release();this._subscriptions=null;this._scrollDownTimeoutListener&&clearTimeout(this._scrollDownTimeoutListener);this._scrollDownTimeoutListener=null;oa=false;ga=da;},insertUnseenStory:function(qa,ra){if(qa)ma[qa]=ra;},getStoryCount:function(){return aa;}};e.exports=pa;},null);